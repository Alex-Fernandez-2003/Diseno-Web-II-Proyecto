<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <link rel="stylesheet" href="./CSS/global.css" />
    <link rel="stylesheet" href="./CSS/home.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="margin">
      <div class="mobile">
        <div class="section-list">
          <select class="taskListSelect" id="taskListSelect"></select>
        </div>
        <div class="section-options">
          <div class="option">
            <p>Listas</p>
            <a href="listas.html">
              <img src="images/iconList.png" alt="Listas" />
            </a>
          </div>
          <div class="option">
            <p>Grupos</p>
            <img src="images/iconGroups.png" alt="Grupos" />
          </div>
          <div class="option">
            <p>Config.</p>
            <img src="images/iconConfig.png" alt="Configuracion" />
          </div>
        </div>

        <p class="title">Tareas Pendientes</p>

        <div class="container-task">
          <ul class="task-list">
            <!-- Las tareas se llenarán aquí -->
          </ul>
        </div>

        <div class="container-iconAdd">
          <a href="addTask.html">
            <img class="icon-add" alt="Añadir" src="images/iconMore.png" />
          </a>
          <input
            type="text"
            class="quick-task-input"
            placeholder="Introduzca tarea rápida"
          />
        </div>
        <img class="textures" alt="" src="images/texture.png" />

      </div>
    </div>

    <script>
      // Función para mostrar las listas en el select
      function populateListSelect() {
        const currentUser = localStorage.getItem("currentUser");

        if (currentUser) {
          const listSelect = document.getElementById("taskListSelect");
          const userLists = JSON.parse(localStorage.getItem(currentUser)) || [];

          // Limpiar el select actual
          listSelect.innerHTML = "";

          // Crear la opción predeterminada
          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.text = "Todas las listas";
          listSelect.appendChild(defaultOption);

          // Agregar las listas del usuario al select
          userLists.forEach((list) => {
            const option = document.createElement("option");
            option.value = list.name;
            option.text = list.name;
            listSelect.appendChild(option);
          });
          // Crear la opción "TERMINADAS"
          const completedOption = document.createElement("option");
          completedOption.value = "TERMINADAS";
          completedOption.text = "TERMINADAS";
          listSelect.appendChild(completedOption);

          // Mostrar tareas de la lista seleccionada
          listSelect.addEventListener("change", displayTasks);
        }
      }

      // Función para mostrar las tareas de la lista seleccionada
      function displayTasks() {
        const currentUser = localStorage.getItem("currentUser");
        const selectedList = document.getElementById("taskListSelect").value;

        if (currentUser) {
          const taskListContainer = document.querySelector(".task-list");
          const userLists = JSON.parse(localStorage.getItem(currentUser)) || [];
          taskListContainer.innerHTML = ""; // Limpiar la lista actual

          const listsToShow = selectedList
            ? userLists.filter((list) => list.name === selectedList)
            : userLists;

          listsToShow.forEach((list) => {
            if (list.tasks) {
              // Ordenar las tareas por fecha y hora más antigua
              list.tasks.sort((a, b) => {
                const dateA = new Date(`${a.date || ''}T${a.hour || '00:00'}`);
                const dateB = new Date(`${b.date || ''}T${b.hour || '00:00'}`);
                return dateA - dateB;
              });

              // Crear y agregar los elementos de las tareas al contenedor
              list.tasks.forEach((task, index) => {
                const taskItem = document.createElement("li");
                taskItem.className = "task-item";
                taskItem.innerHTML = `
                    <input type="checkbox" class="checkbox" ${task.completed ? 'checked' : ''} data-list="${list.name}" data-index="${index}" />
                    <div class="item-container"></div>
                    <div class="container-date">                   
                      <div class="date">${task.date || "Sin fecha"}</div>
                      ${task.hour ? `<div class="time">${task.hour}</div>` : ''}
                    </div>
                    <div class="task">${task.name || "Nota de ejemplo..."}</div>
                `;
                taskListContainer.appendChild(taskItem);
              });
            }
          });

          // Agregar evento para manejar el cambio de estado de las tareas
          document.querySelectorAll('.checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', handleCheckboxChange);
          });
        }
      }

      // Función para manejar el cambio del checkbox
      function handleCheckboxChange(event) {
        const checkbox = event.target;
        const listName = checkbox.getAttribute('data-list');
        const taskIndex = checkbox.getAttribute('data-index');
        const currentUser = localStorage.getItem("currentUser");

        if (currentUser) {
          const userLists = JSON.parse(localStorage.getItem(currentUser)) || [];
          const list = userLists.find(list => list.name === listName);

          if (list && list.tasks) {
            list.tasks[taskIndex].completed = checkbox.checked;

            // Guardar los cambios en localStorage
            localStorage.setItem(currentUser, JSON.stringify(userLists));
          }
        }
      }

      // Ejecutar las funciones cuando se carga la página
      document.addEventListener("DOMContentLoaded", () => {
        populateListSelect();
        displayTasks(); // Mostrar todas las tareas inicialmente
      });
    </script>
  </body>
</html>
